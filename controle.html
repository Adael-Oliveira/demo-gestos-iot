<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Controle por Gestos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  background: #111;
  color: #fff;
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 10px;
}

video {
  width: 90%;
  max-width: 420px;
  border-radius: 12px;
  border: 2px solid #00c853;
}

#status {
  margin-top: 12px;
  font-size: 18px;
}

#timer {
  font-size: 22px;
  margin-top: 8px;
  color: #00e676;
}
</style>
</head>

<body>

<h2>✋ Controle por Gestos</h2>
<p>Mão aberta = LIGA | Mão fechada = DESLIGA</p>

<video id="video" autoplay playsinline></video>

<div id="status">Inicializando...</div>
<div id="timer">⏳ 15</div>

<script>
// =================== SUPABASE ===================
const SUPABASE_URL = "https://hrpxkhkvzlpucezxxvrz.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_WLtXjBJsU6LKHtiAmCQFhw_cjZ-m7tQ";

const sb = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

// =================== SESSION ===================
const session_id = localStorage.getItem("session_id");

if (!session_id) {
  alert("Sessão inválida. Retornando para a fila.");
  window.location.href = "index.html";
}

// =================== TIMER ===================
let tempo = 15;
const timerEl = document.getElementById("timer");

const timerInterval = setInterval(async () => {
  tempo--;
  timerEl.innerText = "⏳ " + tempo;

  if (tempo <= 0) {
    clearInterval(timerInterval);

    await sb.from("fila")
      .delete()
      .eq("session_id", session_id);

    window.location.href = "index.html";
  }
}, 1000);

// Remove da fila ao fechar / atualizar
window.addEventListener("beforeunload", async () => {
  await sb.from("fila")
    .delete()
    .eq("session_id", session_id);
});

// =================== MEDIA PIPE ===================
const video = document.getElementById("video");
const statusEl = document.getElementById("status");

let estadoAtual = null;
let ultimoComando = 0;

const hands = new Hands({
  locateFile: file =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

hands.onResults(async results => {
  if (!results.multiHandLandmarks) return;

  const p = results.multiHandLandmarks[0];

  const maoAberta =
    p[8].y < p[6].y &&
    p[12].y < p[10].y &&
    p[16].y < p[14].y &&
    p[20].y < p[18].y;

  const agora = Date.now();
  if (agora - ultimoComando < 1200) return;

  if (maoAberta && estadoAtual !== true) {
    estadoAtual = true;
    ultimoComando = agora;

    statusEl.innerText = "✋ MÃO ABERTA → LIGANDO";

    await sb.from("estado_rele")
      .update({ estado: true })
      .eq("id", 1);
  }

  if (!maoAberta && estadoAtual !== false) {
    estadoAtual = false;
    ultimoComando = agora;

    statusEl.innerText = "✊ MÃO FECHADA → DESLIGANDO";

    await sb.from("estado_rele")
      .update({ estado: false })
      .eq("id", 1);
  }
});

// =================== CAMERA ===================
const camera = new Camera(video, {
  onFrame: async () => {
    await hands.send({ image: video });
  },
  width: 640,
  height: 480
});

camera.start().then(() => {
  statusEl.innerText = "Câmera ativa. Faça o gesto!";
});
</script>

</body>
</html>
