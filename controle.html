<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle por Gestos</title>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>

<body>
  <h2>Controle por Gestos</h2>
  <video id="video" autoplay></video>

  <script>
    const SUPABASE_URL = "https://hrpxkhkvzlpucezxxvrz.supabase.co";
    const SUPABASE_KEY = "sb_publishable_WLtXjBJsU6LKHtiAmCQFhw_cjZ-m7tQ";

    const video = document.getElementById("video");
    const userId = new URLSearchParams(window.location.search).get("user");

    async function atualizarRele(estado) {
      await fetch(`${SUPABASE_URL}/rest/v1/estado_rele`, {
        method: "POST",
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`,
          "Content-Type": "application/json",
          "Prefer": "resolution=merge-duplicates"
        },
        body: JSON.stringify({ id: 1, ligado: estado })
      });
    }

    const hands = new Hands({
      locateFile: file =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });

    hands.onResults(results => {
      if (!results.multiHandLandmarks) return;

      const mao = results.multiHandLandmarks[0];
      const polegar = mao[4].y;
      const indicador = mao[8].y;

      if (indicador < polegar) {
        atualizarRele(true);   // mão aberta
      } else {
        atualizarRele(false);  // mão fechada
      }
    });

    const camera = new Camera(video, {
      onFrame: async () => {
        await hands.send({ image: video });
      },
      width: 640,
      height: 480
    });

    camera.start();

    window.onbeforeunload = async () => {
      await fetch(`${SUPABASE_URL}/rest/v1/fila?user_id=eq.${userId}`, {
        method: "DELETE",
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        }
      });
    };
  </script>
</body>
</html>
