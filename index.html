<!DOCTYPE html>
<html>
<head>
  <title>Fila de Acesso</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h2 id="msg">Entrando na fila...</h2>

<script>
const sb = supabase.createClient(
  "https://hrpxkhkvzlpucezxxvrz.supabase.co",
  "sb_publishable_WLtXjBJsU6LKHtiAmCQFhw_cjZ-m7tQ"
);

let session_id = localStorage.getItem("session_id");
if (!session_id) {
  session_id = crypto.randomUUID();
  localStorage.setItem("session_id", session_id);
}

async function entrarNaFila() {
  // verifica se já está na fila
  const { data } = await sb
    .from("fila")
    .select("id")
    .eq("session_id", session_id);

  if (!data || data.length === 0) {
    await sb.from("fila").insert({
      session_id,
      status: "aguardando"
    });
  }
}

async function loopFila() {
  setInterval(async () => {
    const { data } = await sb
      .from("fila")
      .select("*")
      .order("entrou_em", { ascending: true });

    if (!data || data.length === 0) return;

    const pos = data.findIndex(f => f.session_id === session_id) + 1;
    document.getElementById("msg").innerText = "Sua posição: " + pos;

    if (pos === 1) {
      window.location.href = "controle.html";
    }
  }, 2000);
}

entrarNaFila();
loopFila();
</script>

</body>
</html>
